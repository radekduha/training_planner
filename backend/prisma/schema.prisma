generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model TrainingType {
  id        Int           @id @default(autoincrement())
  name      String        @unique
  durationMinutes Int     @default(240)
  teachingHours Float?
  maxParticipants Int?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  trainings Training[]
  skills    TrainerSkill[]
}

model Trainer {
  id             Int           @id @default(autoincrement())
  titlePrefix    String?
  firstName      String
  lastName       String        @default("")
  titleSuffix    String?
  akris          Boolean       @default(false)
  callBeforeTraining Boolean   @default(false)
  frequencyQuantity String?
  frequencyPeriod String?
  limitNote     String?
  email          String?
  phone          String?
  homeAddress    String
  homeLat        Float?
  homeLng        Float?
  hourlyRate     Float?
  travelRateKm   Float?
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  skills         TrainerSkill[]
  rules          TrainerRule[]
  assignedTrainings Training[]
  availabilitySlots TrainerAvailabilitySlot[]
}

model TrainerSkill {
  id             Int          @id @default(autoincrement())
  trainerId      Int
  trainingTypeId Int
  trainer        Trainer      @relation(fields: [trainerId], references: [id], onDelete: Cascade)
  trainingType   TrainingType @relation(fields: [trainingTypeId], references: [id], onDelete: Cascade)

  @@unique([trainerId, trainingTypeId])
}

model TrainerRule {
  id        Int     @id @default(autoincrement())
  trainerId Int
  ruleType  String
  ruleValue String
  trainer   Trainer @relation(fields: [trainerId], references: [id], onDelete: Cascade)

  @@index([trainerId, ruleType])
}

model Training {
  id               Int          @id @default(autoincrement())
  trainingTypeId   Int
  customerName     String?
  address          String
  lat              Float?
  lng              Float?
  requestWindowStart DateTime?
  requestWindowEnd DateTime?
  startDatetime    DateTime
  endDatetime      DateTime
  status           String
  assignedTrainerId Int?
  assignmentReason String?
  changedBy        String?
  googleEventId    String?
  notes            String?
  visitors         Int?
  accreditation    Boolean?
  hours            Int?
  trainersFee      Float?
  priceWithVat     Float?
  payerAddress     String?
  payerId          String?
  invoiceNumber    String?
  trainingPlace    String?
  contactName      String?
  contactPhone     String?
  invoiceEmail     String?
  approvalEmail    String?
  studyMaterials   String?
  infoForTheTrainer String?
  pp               String?
  d                String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  trainingType     TrainingType @relation(fields: [trainingTypeId], references: [id], onDelete: Restrict)
  assignedTrainer  Trainer?     @relation(fields: [assignedTrainerId], references: [id], onDelete: SetNull)
  assignedSlot     TrainerAvailabilitySlot? @relation("AssignedTrainingSlot")

  @@index([startDatetime])
  @@index([status])
  @@index([assignedTrainerId])
  @@index([requestWindowStart, requestWindowEnd])
}

model TrainerAvailabilitySlot {
  id               Int      @id @default(autoincrement())
  trainerId        Int
  startDatetime    DateTime
  endDatetime      DateTime
  isActive         Boolean  @default(true)
  assignedTrainingId Int?   @unique
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  trainer          Trainer  @relation(fields: [trainerId], references: [id], onDelete: Cascade)
  assignedTraining Training? @relation("AssignedTrainingSlot", fields: [assignedTrainingId], references: [id], onDelete: SetNull)

  @@index([trainerId, startDatetime, endDatetime])
  @@index([isActive, startDatetime])
}

model GeocodingCache {
  id        Int      @id @default(autoincrement())
  address   String   @unique
  lat       Float
  lng       Float
  provider  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
